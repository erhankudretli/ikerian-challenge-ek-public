name: ğŸ› ï¸ Terraform Apply (Requires Approval)
run-name: Deployment to ${{ github.ref_name }} - Run Number ${{ github.run_number }}

# Trigger on push to 'dev' or 'prd' branches only.
on:
  push:
    branches:
      - dev
      - prd

# Requires 'write' permissions for state manipulation.
permissions:
  contents: read 
  # 'pull-requests: write' is required for adding PR comments (e.g., Infracost).
  pull-requests: write 

jobs:
  # --------------------------------------------------------------------------------
  # JOB 1: PLAN, VALIDATE, ARTIFACTS, AND COST ESTIMATION (NO APPLY)
  # --------------------------------------------------------------------------------
  terraform-plan:
    runs-on: ubuntu-latest
    
    # AWS credentials provided via repository secrets.
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
    
    # This job doesn't need environment approval, it just prepares the plan.
    environment: ${{ github.ref_name }} 

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4

      # Set working directory (dev or prd).
      - name: âš™ï¸ Set Working Directory
        id: set-dir
        run: |
          echo "dir=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      - name: â™»ï¸ Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ steps.set-dir.outputs.dir }}

      - name: âœ… Terraform Validate
        run: terraform validate
        working-directory: ${{ steps.set-dir.outputs.dir }}

      - name: ğŸ“ Terraform Plan & Save to Binary
        id: plan
        run: |
          # Saves the plan as both human-readable text (no color) and binary artifact.
          terraform plan -no-color -var-file=terraform.tfvars -out=tfplan.binary | tee tfplan.txt
        working-directory: ${{ steps.set-dir.outputs.dir }}

      - name: â¬†ï¸ Upload Plan Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.ref_name }}-tfplan-${{ github.run_id }}
          path: |
            ${{ steps.set-dir.outputs.dir }}/tfplan.txt
            ${{ steps.set-dir.outputs.dir }}/tfplan.binary

      # ---------------- INFRACOST COST ESTIMATION ----------------
      - name: ğŸ’° Setup Infracost CLI
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: ğŸ“ˆ Run Infracost Breakdown
        run: |
          infracost breakdown \
            --path ${{ steps.set-dir.outputs.dir }}/tfplan.binary \
            --format table \
            --out-file infracost.txt
          echo "----- Infracost Breakdown -----"
          cat infracost.txt
        # Pass API key via env var for the CLI tool
        env:
          INFRACOST_API_KEY: ${{ secrets.INFRACOST_API_KEY }} 

      - name: â¬†ï¸ Upload Infracost Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.ref_name }}-infracost-${{ github.run_id }}
          path: infracost.txt

      - name: ğŸ“„ Summary (Terraform Plan + Cost)
        run: |
          echo "## ğŸ“„ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat ${{ steps.set-dir.outputs.dir }}/tfplan.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          echo "## ğŸ’° Infracost Estimate" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat infracost.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # --------------------------------------------------------------------------------
  # JOB 2: APPROVED APPLY (REQUIRES MANUAL APPROVAL VIA ENVIRONMENT)
  # --------------------------------------------------------------------------------
  terraform-apply:
    needs: terraform-plan # Must wait for plan/cost estimation to finish.
    runs-on: ubuntu-latest
    
    # This environment setting triggers the "Required reviewers" protection rule.
    environment: ${{ github.ref_name }} 
    
    # Only runs on 'dev' or 'prd' branches.
    if: github.ref_name == 'dev' || github.ref_name == 'prd' 

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: âš™ï¸ Set Working Directory
        id: set-dir
        run: |
          echo "dir=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: âš™ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.3.0

      # Download the binary plan artifact for safe application.
      - name: â¬‡ï¸ Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.ref_name }}-tfplan-${{ github.run_id }}
          path: ${{ steps.set-dir.outputs.dir }} # Download to the working directory.

      - name: â™»ï¸ Terraform Init (Required after downloading artifact)
        id: init
        run: terraform init
        working-directory: ${{ steps.set-dir.outputs.dir }}

      - name: ğŸš€ Terraform Apply
        run: terraform apply -auto-approve tfplan.binary
        working-directory: ${{ steps.set-dir.outputs.dir }}
